---
title: "Flex crop analysis"
author: "Robin Lindström"
date: "20/10/2019"
output:
  html_document:
      number_sections: true
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(root.dir = "~/Google Drive/SRC/Thesis/")
Sys.setlocale('LC_ALL','C')
```


```{r initiate, echo = FALSE, include = FALSE}
setwd(getwd())
library(scales)
library(gridExtra)
library(sf) # For loading map data
#library(tmap)
library(plotly)
source("~/Google Drive/SRC/Thesis/x.Code/Scripts/flex_crops_functions.R")

#setwd("~/Google Drive/SRC/Thesis/")
theme_set(theme_light(base_size = 8))
```

```{r read_data, echo = FALSE, include = FALSE}
# Get the crop data from the raw data
data_path = "~/Google Drive/SRC/Thesis/x.Code/Data/Crop production/Production_Crops_E_All_Data.csv"
crop_production_data_raw = read_data(data_path)
```


```{r get_crop_data, echo = FALSE, include = FALSE}
# Get names of different crop groups
all_crops = unique(crop_production_data_raw$item)
flex_crops = c("Soybeans", "Sugar cane", "Oil palm fruit", "Maize")
emerging_flex_crops = c("Cassava", "Rapeseed", "Sugar beet", "Sunflower seed", "Coconuts") # Have left out coconuts
other_crops = setdiff(flex_crops, all_crops)
used_measure = c("Production", "Area harvested", "Yield")

world = map_data("world") %>%
  filter(region != "Antarctica")

# check decade before and after financial crash
year = 1961:2016

crop_data = get_crop_data(crop_production_data_raw, all_crops, measure = used_measure, year)
```

# Analysis

## Some key findings
* **Global flex crop production as proportion of total crop production is increasing and could pass non flex crops in a near future**
* **Oil palm fruit has the highest market concentration and could be considered a highly concentrated markets. All other flex crops fall under moderately concentrated markets, where soybeans has been declining, sugar cane increasing and maize been relatively constant.**
* **On a global level yield is much higher for flex crops than for other crops in general, and it has steadily increased but could be starting to decrease**
* **Soybean production is increasing more than maize production, and could potentially pass in a near future.**
* **The expansion of flex crops comes with an ecological cost, often in a decrease of forest cover. It also has implications for the production of staple crops, since while some countries have seen an increase in soybean or oil palm production it has at the same time seen a significant decrease in other stable crops like wheat, barley and rice**
* **The expansion of flex crops comes with an ecological cost, often in a decrease of forest cover.**

## Global aggregated analysis of flex crop production

First it is interesting to see how the total production of flex crops and non flex crops has been evolving over time. Since increasing yields requires intensive farming with high inputs, leading to greater envitonmental impacts (Mózner et al. 2012), it is also interesting to compare the average yield of the two categories.

### Global total production of flex crops
Time series of total production, area harvested and yield of flex crops and non flex crops. Non flex crops is just defined as all other crops that are not defined as flex crops or emerging flex crops.

```{r flex_crop_total_production, fig.height = 4, fig.width = 8, echo = FALSE}

#crop_data = get_crop_data(crop_production_data_raw, all_crops, measure, year)
time_series_category_plot(crop_data, index_plot = FALSE, scale = "free_y")

```

Average yield is much higher for flex crops and has increased for flex crops over time, but it looks like it could potentially be on a decline in the last decade. One could also ask if there is a relationship between the increased production and the decrease in average yield for flex crops? Have these crops expanded to new markets where yields are lower? Have they been intensified so much that the soils are degrading and not giving the same yields anymore? Not surprisingly flex crops have increased in production. Note that the area harvested increasing the most somewhere this last decade and it would be interesting to explore further. To be able to compare the two categories better we plot the them as a share of total crop production.

### Global total production of each category as share of total production

```{r flex_crop_production_share, fig.height = 3, fig.width = 8, echo = FALSE}

#crop_data = get_crop_data(crop_production_data_raw, all_crops, measure, year)
used_measure = c("Production", "Area harvested")
time_series_crop_comparison_plot_proportion(crop_data, measure = used_measure)

```

This is shows another interesting pattern since now we can see that non flex crops are decreasing as a total share of both production and area harvested, while flex crops are increaseing. If this pattern continues we could see that the share of flex crops are actually taking over the share of non flex crops. It would be interesting to check when is that predicted to happen according to the data. Next we look at the production individual flex crops.

### Global total production of individual flex crops.
Time series (as a proportion of all flex crops)

```{r fig.height = 5, fig.width = 6, echo = FALSE}

used_measure = c("Production", "Area harvested")
#crop_data = get_crop_data(crop_production_data_raw, all_crops, measure, year)
time_series_crop_comparison_plot(crop_data, category = "Flex crop", measure = used_measure, fraction = FALSE)

```

In terms of area harvested we can see that maize and soybean are by far the crops claiming the most land. Both are growing but how does it look like if we look at a proportion of each other?

### Global production of individual flex crop production (proportion).
Each flex crop is plotted as a proportion of total flex crop production.

```{r fig.height = 5, fig.width = 6, echo = FALSE}

used_measure = c("Production", "Area harvested")
#crop_data = get_crop_data(crop_production_data_raw, all_crops, measure, year)
time_series_crop_comparison_plot(crop_data, category = "Flex crop", measure = used_measure, fraction = TRUE)

```

Here we see that even though maize is increasing in area harvested in absolute numbers, soybean is increasingly taking over shares as a flex crop. This makes me wonder if there are numbers on what maize and soybeans are used for?

### Concentration of the worlds production of flex crop
This plot shows us, in terms om tonnes produced, which countries are producing the greatest share of each crop globally. The cut-off point is set to 80%, which means that the countries that together accountfor at least 80% of the production (in 2017) is shown, the rest is lumped together as others.

```{r flex_crop_production_concentration, fig.height = 8, fig.width = 10, echo = FALSE}

#crop_data = get_crop_data(crop_production_data_raw, all_crops, measure, year)
#map(flex_crops, function(x) {
  
p1 = stacked_area_plot(crop_data, category = "Flex crop", crop = "Soybeans",
                       measure = "Production", cut_off = 0.8)
p2 = stacked_area_plot(crop_data, category = "Flex crop", crop ="Sugar cane",
                       measure = "Production", cut_off = 0.8)
p3 = stacked_area_plot(crop_data, category = "Flex crop", crop ="Oil palm fruit",
                       measure = "Production", cut_off = 0.8)
p4 = stacked_area_plot(crop_data, category = "Flex crop", crop ="Maize",
                       measure = "Production", cut_off = 0.8)

#p2 = stacked_area_plot(crop_data, category = "Flex crop", crop = x,
  #                           measure = "Area harvested", n_countries = 5)
  
#ggarrange(p1, p2, p3, p4, ncol = 2, nrow = 2)

grid.arrange(p1, p2, p3, p4)
  
#})

```

The patterns here are not surprising. Indonesia and Malaysia dominates the world production of Oil palm, Brazil and Argentina has emerged as a greater share of the soybean production where the US has been historically dominating. Interesting might be that Maize production share seem to stay more constant compared to the others. Is this because maize is to a greater extent produced where it can be produced, while for example Oil palm has been introduced in countries like Malaysia and Indonesia fairly recently and has changed the concentration. To get a slightly different angle we will check the market concentration of these products.

### Other cut off points
For palm oil and sugar cane ther others group has historically been quite large. To see which producers that where big then we can increase the cut-off point.

```{r historical_producers, fig.height = 8, fig.width = 10, echo = FALSE}

p1 = stacked_area_plot(crop_data, category = "Flex crop", crop ="Sugar cane",
                       measure = "Production", cut_off = 0.90)
p2 = stacked_area_plot(crop_data, category = "Flex crop", crop ="Oil palm fruit",
                       measure = "Production", cut_off = 0.98)

grid.arrange(p1, p2)

```

Here we can see that for sugar cane Vietnam used to be significant producers up unitil the 90s. In the 60s and 70s Nigeria used to be a major producer of the oil palm fruit.

**Market concentration**
The Herfindahl–Hirschman Index (HHI) is a measure of market concentration (Investopedia 2019, Herfindahl-Hirschman Index) and to determine the competativeness of a market. According to the Department of Justice and the Federal Trade Commission of the United States of America (Department of Justice 2010) the concentration of a specific market can be measured by the following ranges

* Unconcentrated Markets: HHI below 1500
* Moderately Concentrated Markets: HHI between 1500 and 2500
* Highly Concentrated Markets: HHI above 2500

### Market concentration of global production of flex crops

```{r fig.height = 3, fig.width = 5, echo = FALSE}

category = "Flex crop"
used_measure = c("Production")
plot_HH_index(crop_data, category, measure = used_measure)

```

This also confirms that the market concentration has been fairly stable for Maize. Here we can see that in terms of production the market concentration went down on Soybeans, which is in line with Oliviera & Schneider (2016) that the concentration withered with the expansion of production in Brazil and China. The market concentration for oil palm fruit has increased, and is the only one which today would clearly fall into the category "highly concentrated market". The reasons for this are captured by this quote by the president of the Colombian FEDEPALMA:

> Oil palm industry development of our world leader, Indonesia, is underpinned by cheap labor force, low production costs and large swathes of land given under concession and other forms by the government. But those conditions are neither easy to find somewhere else, especially in Latin America, nor sustainable. Thus, oil palm agroindustry must build and consolidate com- petitive advantages over more solid bases (Hunsberger & Alonso-Fradejas 2016)

### Individual flex crop planted area proportion of total land area
Large countries will naturally be the ones with the largest area planted. Here we look what proportion of the total crop production is flex crop production and how has it changed over time. With this information we can see if the flex crop production is actually displacing other production.

Here a threshold is set that a country has at minimum 40% of the total area planted are flex crops in 2017. This number was mainly chosen because most countries after that are nations that have maize as a large part of their total production, but has had it for a long time and that share has been fairly stable over time. The reason why 2017 is chosen as a baseline is because it is interesting to focus on the where the production is dominant today, and how that have developed for those countries historically.

```{r  out.width = "100%", out.height = "100%", fig.height = 6, echo = FALSE}

crop_proportion_plot_per_country(crop_data, category = "Flex crop", min_land_area = 500000, min_proportion = 0.4, max_proportion = 1, stacked = TRUE)

```

Some interesting points from these graphs
* The first interesting observation is that even though we have set the threshold to a 25% and excluded smaller nations we still have 37 countries that have more than (setting it to 10% gives us 78 countries, or 99 countries at 5%). This is a lot more countries than I thought would have their cropland use so dominated by flex crops.

* Both Indonesia and Malaysia are two giants when it comes to production of Palm oil. Here it becomes very clear that Malaysia differs very much from Indonesia in the sense that Malaysia has had an remarkable increase of proportion of oil palm produced. From a almost nothing up until the 70s to more than 50% in 2015.

* Besides the ususal suspects of Brazil and Argentina, in latin america Bolivia, Paraguay and Uruguay has had a growth which deserves more attention. Especially looking at Paraguay and Uruguay who grown from a proportion of area that soybeans are grown on from almost 0 in the 70s to around 60% in 2015 and from close to 0 in 2000 to over 50% in 2015. In the speed this has happened maybe Uruguay is the most remarkable. The question I ask myself is where this land has come from?

* Maize is somewhat fluctuating in area harvested over time, but its proportion generally does not increase much, with a few exeptions (Tanzania, Guatemala and DR Congo).

An interesting question overall here would be on what expense is this expansion of flex crops? In many tropical countries it is known that important biomes, like rainforest in Latin America or South-east Asia or the cerrado in Brazil is cleared for production of for example soy, oil palm and sugar cane plantations. The questions is if flex crops also are expanding into other food production, e.g. if other crops are replaced by the flex crops? If this is true, given that these crops tend to a greater extent (source???) be used for other uses than directly for food, how does that affect food security in a region where this transition has happened? What are the effects on livelihoods of the people who used to live on growing other crops? Are corporations behind this expansion? Where does the demand come from? Have people been displaced from their lands because of this expansion? Have some benefitted and others not? Are these benefits gendered? What sort of governing institutions has made this possible? Where does the financing come from for this expansion? How much are the financial institutions interacting with the governing institutions?

A reflection I have when I write this is that flex crops is bit of a problematic word. The way I use and think of the word is that they are problematic crops, since they have been shown in some cases to have been used to other things that aren't food related (e.g. biofuels, industrial materials etc.) and things that could be argued are not very effective use of calories (e.g. feed). This is true in some cases of course, but in many countries these are staple goods and a very important part of food security. I think it is important to sometimes reflect over that the producton of Maize in the US is very different from Maize production in Malawi, and that should be taken into account when doing this type of analysis.

## Case study - Uruguay
Example of what social-ecological effects of increased flex crop production.

### General crop production in Uruguay
To see what other crops that potentially could be displaced, the most produced crops are plotted here.

```{r uruguay_crop_production, fig.height = 3, fig.width = 9, echo = FALSE}

#theme_set(theme_classic(base_size = 8))

measure_var = c("Production", "Area harvested")
country_var = "Paraguay"
year_var = 1961:2016

#p1 = plot_country_crop_data(crop_data, country_var,
#                            measure_var = "Production", cut_off = 0.9, year_var, stacked = TRUE)
p1 = plot_country_crop_data(crop_data, country_var,
                            measure_var = "Area harvested", cut_off = 0.9, year_var, stacked = TRUE)

p2 = crop_diversity_HH_index(crop_data, spatial_extension = "country", country_var)
  
lay <- rbind(c(1,1,1,1,2,2),
             c(1,1,1,1,2,2))
  
grid.arrange(p1, p2, layout_matrix = lay)

```

Here we can see that not only is soybeans increasing both in production and area harvested, others staple crops like wheat, barley, rice are declining. It would be interesting to pair this with trade data to see how imports and exports have evolved for these staple crops in Uruguay. To see the ecological effects of this we can see how the land use has changed during this time period.

### Land use change in Uruguay
Using data from FAO we plot the land use and land cover over time to see if it can help explain the effects of the rapid increase of soy in the total crop planting.

```{r uruguay_land_use, fig.height = 3, fig.width = 5, echo = FALSE}
land_use_plot("Uruguay", stacked = FALSE)
land_cover_plot("Uruguay")
#ggarrange(p1, p2)
```

From this graph we see that there has been an increase in cropland area as a share of the total land area, which does correspond to an increase in soybean area increase. This has happened at the expense of Land under perm. meadows and pastures. According to the FAO this is:

"land used permanently (five years or more) to grow herbaceous forage crops through cultivation or naturally (wild prairie or grazing land). Permanent meadows and pastures on which trees and shrubs are grown should be recorded under this heading only if the growing of forage crops is the most important use of the area. Measures may be taken to keep or increase productivity of the land (i.e., use of fertilizers, mowing or systematic grazing by domestic animals.) This class includes:
* Grazing in wooded areas (agroforestry areas, for example)
* Grazing in shrubby zones (heath, maquis, garigue)
* Grassland in the plain or low mountain areas used for grazing: land crossed during transhumance where the animals spend a part of the year (approximately 100 days) without returning to the holding in the evening: mountain and subalpine meadows and similar; and steppes and dry meadows used for pasture."

## Comparing the social-ecological effects in Malaysia and Indonesia
Since both Malaysia and Indonesia are similar in terms that they both have had an incerible increase in production of palm oil in the last decades, it would be interesting to compare the social-ecological effects in these two countries.

### General crop production comparison of Malaysia and Indonesia

```{r malaysia_indonesia_crop_production, fig.height = 6, fig.width = 9, echo = FALSE}

#theme_set(theme_classic(base_size = 8))

measure_var = c("Production", "Area harvested")
n_items = 5
year_var = 1961:2016

p1 = plot_country_crop_data(crop_data, country_var = "Malaysia", measure_var, n_items, year_var, stacked = FALSE)
p2 = plot_country_crop_data(crop_data, country_var = "Indonesia", measure_var, n_items, year_var, stacked = FALSE)

grid.arrange(p1, p2)

```

### Land use change compratison of Malaysia and Indonesia


```{r malaysia_indonesia_land_use, fig.height = 3, fig.width = 10, echo = FALSE}
p1 = land_use_plot("Malaysia", stacked = FALSE)
p2 = land_use_plot("Indonesia", stacked = FALSE)
ggarrange(p1, p2)
```

Here we see that Indonesia has likely lost forest land while the crop land has increased. Malaysia has had similar type of increase in crop land but interestingly their forest land are the same levels today as in the 90s.

### Paraguay

```{r paraguay_crop_production, fig.height = 6, fig.width = 9, echo = FALSE}

measure_var = c("Production", "Area harvested")
country = "Uruguay"
n_items = 8
year_var = 1992:2016

p1 = plot_country_crop_data(crop_data, country_var = country, measure_var, n_items, year_var, stacked = FALSE)
p2 = land_use_plot(country = country, stacked = FALSE)

# Setup the design of the grid.arrange
lay <- rbind(c(1,1,1),
             c(2,2,2))
  
grid.arrange(p1, p2, layout_matrix = lay)

```

Here we can see that Paraguay is showing similar patterns as Indonesia.

### Brazil

```{r brazil_crop_production, fig.height = 6, fig.width = 9, echo = FALSE}

measure_var = c("Production", "Area harvested")
country = "Brazil"
n_items = 5
year_var = 1961:2016

p1 = plot_country_crop_data(crop_data, country_var = country, measure_var, n_items, year_var, stacked = FALSE)
p2 = land_use_plot(country = country, stacked = FALSE)

# Setup the design of the grid.arrange
lay <- rbind(c(1,1,1),
             c(2,2,2))

grid.arrange(p1, p2, layout_matrix = lay)

```

Which is also true for Brazil.

### Argentina

```{r argentina_crop_production, fig.height = 6, fig.width = 9, echo = FALSE}

measure_var = c("Production", "Area harvested")
country = "Argentina"
n_items = 5
year_var = 1961:2016

p1 = plot_country_crop_data(crop_data, country_var = country, measure_var, n_items, year_var, stacked = FALSE)
p2 = land_use_plot(country = country, stacked = FALSE)

# Setup the design of the grid.arrange
lay <- rbind(c(1,1,1),
             c(2,2,2))

grid.arrange(p1, p2, layout_matrix = lay)

```

..and Argentina.

## Break point analysis
Using the package Fstats, the F statistics is calculated for every potential break point. Two OLS are fitted to the observations before and after the potential break points. The breakpoint that minimizes the RSS is the point that is picked (rdocumentation.org). Here I look at each county's area harvested of a certain crop over time. The distribution of break points are plottet in a histogram, to see if there are certain years with more break points than others. The map is colored after which range that the break point in a specific country falls in. The ranges are chosen to represent the different food regimes defined in (McMichael 2009)

Second food regime: 1950-1970s
Third food regime:  late 1980s-Present

```{r, fig.height = 6, echo = FALSE}
get_break_points_per_country(crop_data, crop = "Oil palm fruit", measure = "Area harvested")
```

Most of the oil palm producing countries has had the break point after 1990s. The exepctions are Paraguay, Benin, Tanzania and Madagascar.

```{r, fig.height = 6, echo = FALSE}
get_break_points_per_country(crop_data, crop = "Soybeans", measure = "Area harvested")
```


```{r, fig.height = 6, echo = FALSE}
get_break_points_per_country(crop_data, crop = "Sugar cane", measure = "Area harvested")
```

Here it seems like that significantly greater number of countries have had their break point during the second food regime, than for exampel soybean and oil palm.

```{r, fig.height = 6, echo = FALSE}
get_break_points_per_country(crop_data, crop = "Maize", measure = "Area harvested")
```
Like soybean and oil palm, maize seem to have most of the breakpoints during the third food regime.

Sources:

McMichael, P. 2009. A food regime genealogy. Journal of Peasant Studies 36(1):139–169.

Mózner, Z., A. Tabi, and M. Csutora. 2012. Modifying the yield factor based on more efficient use of fertilizer - The environmental impacts of intensive and extensive agricultural practices. Ecological Indicators 16:58–66.

Oliveira, G. de L. T., and M. Schneider. 2016. The politics of flexing soybeans: China, Brazil and global agroindustrial restructuring. Journal of Peasant Studies 43(1):167–194.

