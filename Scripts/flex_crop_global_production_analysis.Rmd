---
title: "Flex crop analysis"
author: "Robin Lindström"
date: "20/10/2019"
output:
  html_document:
      number_sections: true
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(root.dir = "~/Google Drive/SRC/Thesis/")
Sys.setlocale('LC_ALL','C')

library(scales)
library(gridExtra)
library(sf) # For loading map data
#library(tmap)
library(plotly)
theme_set(theme_light(base_size = 8))
setwd(getwd())
```


```{r read_functions, echo = FALSE, include = FALSE}

source("~/Google Drive/SRC/Thesis/x.Code/Scripts/flex_crops_functions.R")
#setwd("~/Google Drive/SRC/Thesis/")
```


```{r get_raw_data, echo = FALSE, include = FALSE}
# Get the crop data from the raw data
data_path = "~/Google Drive/SRC/Thesis/x.Code/Data/Crop production/Production_Crops_E_All_Data.csv"
crop_production_data_raw = read_production_data(data_path)
```

```{r get_crop_data, echo = FALSE, include = FALSE}
# Get names of different crop groups
all_crops = unique(crop_production_data_raw$item)
flex_crops = c("Soybeans", "Sugar cane", "Oil palm fruit", "Maize", "Cassava")
emerging_flex_crops = c("Rapeseed", "Sugar beet", "Sunflower seed", "Coconuts")
other_crops = setdiff(flex_crops, all_crops)
used_measure = c("Production", "Area harvested", "Yield")

world = map_data("world") %>%
  filter(region != "Antarctica")

# check decade before and after financial crash
year = 1961:2017

crop_data = get_crop_data(crop_production_data_raw, all_crops, measure = used_measure, year)
```

## Global aggregated analysis of flex crop production

First it is interesting to see how the total production of flex crops and non flex crops has been evolving over time. Since increasing yields requires intensive farming with high inputs, leading to greater envitonmental impacts (Mózner et al. 2012), it is also interesting to compare the average yield of the two categories.

### Global total production of flex crops
Time series of total production, area harvested and yield of flex crops and non flex crops. Non flex crops is just defined as all other crops that are not defined as flex crops or emerging flex crops.

```{r fig.height = 2, fig.width = 7}

crop_group_global_harvest = crop_data %>% 
  filter(measures == "Area harvested") %>% 
  group_by(year, crop_category) %>% 
  summarise(total_crop_category_harvest = sum(value)) %>% 
  ungroup() %>% 
  group_by(year) %>% 
  mutate(total_annual_crop_harvest = sum(total_crop_category_harvest)) %>% 
  mutate(crop_category_share = total_crop_category_harvest / total_annual_crop_harvest)

# Plot the relative and absolute temporal change in export value of the different crop groups ---
p1 = crop_group_global_harvest %>% 
  ggplot(aes(x = year, y = crop_category_share, color = crop_category)) +
  geom_line() +
  labs(title = "Crop group harvest amount", subtitle = "Relative", x = "", y = "proportion", color = "")

p2 = crop_group_global_harvest %>% 
  ggplot(aes(x = year, y = total_crop_category_harvest, color = crop_category)) +
  geom_line() +
  labs(title = "Crop group harvest amount", subtitle = "Absolute", x = "", y = "hectares", color = "")

ggarrange(p1, p2, ncol = 2)

# export_commodity_value = export_value %>% 
#   group_by(year, crop_category) %>% 
#   summarise(total_crop_category_value_per_year = sum(export_value)) %>% 
#   ungroup() %>% 
#   group_by(year) %>% 
#   mutate(total_value_per_year = sum(total_crop_category_value_per_year)) %>% 
#   mutate(crop_category_share = total_crop_category_value_per_year / total_value_per_year)
```

```{r}
crop_group_global_harvest = crop_data %>% 
  filter(measures == "Area harvested") %>% 
  group_by(year, crop_category) %>% 
  mutate(total_crop_category_harvest = sum(value)) %>% 
  ungroup() %>% 
  group_by(year, country_group) %>% 
  mutate(total_annual_crop_harvest = sum(total_crop_category_harvest)) %>% 
  mutate(crop_category_share = total_crop_category_harvest / total_annual_crop_harvest)

# Plot the relative and absolute temporal change in export value of the different crop groups ---
p1 = crop_group_global_harvest %>% 
  ggplot(aes(x = year, y = crop_category_share, color = crop_category)) +
  geom_line() +
  labs(title = "Area harvested for crop group, relative value", x = "", y = "proportion", color = "") +
  facet_wrap(~country_group, scales = "free_y")

p2 = crop_group_global_harvest %>% 
  ggplot(aes(x = year, y = total_crop_category_harvest, color = crop_category)) +
  geom_line() +
  labs(title = "Area harvested for crop group, absolute value", x = "", y = "hectares", color = "") +
  facet_wrap(~country_group, scales = "free_y")

#ggarrange(p1, p2, ncol = 1)
p2

```

# Highest share of global total
# What is the average flex crop proportion of total area harvested over time in different globally?

```{r flex_crop_total_production, fig.height = 4, fig.width = 8, echo = FALSE}

df = crop_data %>% 
  filter(measures == "Area harvested") %>% 
  select(country, iso3_code, year, crop_category, value, cropland, item, land_area, country_group) %>%
  group_by(year, country) %>% 
  mutate(total_harvested_yearly = sum(value)) %>% 
  #mutate(total_AH = sum(value)) %>% 
  filter(crop_category == "Flex crop") %>%
  mutate(total_harvested_flex_crop = sum(value)) %>% 
  mutate(flex_crop_proportion_harvested = total_harvested_flex_crop / total_harvested_yearly) %>% 
  ungroup() %>% 
  group_by(year, country, item) %>%
  mutate(individual_flex_crop_area_harvested = sum(value)) %>% 
  mutate(individual_flex_crop_proportion_harvested = individual_flex_crop_area_harvested / total_harvested_yearly) %>%
  distinct(country, flex_crop_proportion_harvested, item, .keep_all = TRUE)

df_mean_flex_crop_global = df %>% 
  ungroup() %>% 
  group_by(year) %>% 
  filter(!is.na(flex_crop_proportion_harvested)) %>% 
  mutate(mean_flex_crop_proportion_harvested = mean(flex_crop_proportion_harvested)) %>%
  ungroup() %>% 
  group_by(year, item) %>% 
  mutate(mean_individual_flex_crop_proportion_harvested = mean(individual_flex_crop_proportion_harvested)) %>% 
  distinct(year, mean_individual_flex_crop_proportion_harvested, mean_flex_crop_proportion_harvested)

df_mean_flex_crop_global %>% 
  ggplot(aes(year, mean_individual_flex_crop_proportion_harvested, color = item)) +
  geom_line() +
  labs(title = "Global flex crop proportion of total harvested", fill = "", x = "", y = "Proportion")
```


# What is the change in flex crop proportion in 
```{r flex_crop_total_production, fig.height = 4, fig.width = 8, echo = FALSE}

df_mean_flex_crop_country_group = df %>% 
  ungroup() %>% 
#  filter(country_group == "South America") %>% 
  group_by(year, country_group) %>% 
  filter(!is.na(flex_crop_proportion_harvested)) %>% 
  mutate(mean_flex_crop_proportion_harvested = mean(flex_crop_proportion_harvested)) %>%
  ungroup() %>% 
  group_by(year, item) %>% 
  mutate(mean_individual_flex_crop_proportion_harvested = mean(individual_flex_crop_proportion_harvested)) %>% 
  distinct(year, item, country_group, .keep_all = TRUE)
#  distinct(year, country_group, mean_individual_flex_crop_proportion_harvested, mean_flex_crop_proportion_harvested)
#distinct(year, item, value, country_group, mean_flex_crop_proportion_harvested)
  

df_mean_flex_crop_country_group %>% 
  ggplot(aes(year, mean_individual_flex_crop_proportion_harvested, color = item)) +
  geom_line() +
  facet_wrap(~country_group) +
  labs(title = "Flex crop proportion of area harvested in each country group", fill = "", x = "", y = "Proportion")
```


```{r flex_crop_total_production, fig.height = 4, fig.width = 8, echo = FALSE}
df_change = df %>%
  ungroup() %>% 
  select(year, flex_crop_proportion_harvested, country, item, iso3_code) %>% 
  filter(year %in% c(1993, 2017)) %>% 
  spread(year, flex_crop_proportion_harvested) %>% 
  select(-item) %>% 
  distinct(country, .keep_all = TRUE) %>% 
  mutate(change_abs = `2017` - `1993`) %>% 
  mutate(change_perc = `2017` / `1993`)
  
df_change_map_data = make_map_data(df_change) %>% 
  mutate(change_perc = as.numeric(change_perc))

# How many percentage points has it changed during from 1993 to 2017
df_change_map_data %>%
  ggplot(aes(fill = change_abs)) +
  geom_sf() +
  scale_fill_gradient2() +
  labs(title = "Flex crops as proportion of total area harvested", subtitle = "Change in percentage points",
       fill = str_wrap("Percentage points",5))

```


```{r flex_crop_proportion_per_country out.width = "100%", out.height = "100%", fig.height = 6, echo = FALSE}

crop_proportion_plot_per_country(crop_data, category = "Flex crop", min_land_area = 500000, min_proportion = 0.4, max_proportion = 1, stacked = TRUE)

```

**Market concentration**
The Herfindahl–Hirschman Index (HHI) is a measure of market concentration (Investopedia 2019, Herfindahl-Hirschman Index) and to determine the competativeness of a market. According to the Department of Justice and the Federal Trade Commission of the United States of America (Department of Justice 2010) the concentration of a specific market can be measured by the following ranges

* Unconcentrated Markets: HHI below 1500
* Moderately Concentrated Markets: HHI between 1500 and 2500
* Highly Concentrated Markets: HHI above 2500

### Market concentration of global production of flex crops

```{r fig.height = 3, fig.width = 9, echo = FALSE}

category = "Flex crop"
used_measure = c("Area harvested")
plot_HH_index(crop_data, category, measure = used_measure)

```

This also confirms that the market concentration has been fairly stable for Maize. Here we can see that in terms of production the market concentration went down on Soybeans, which is in line with Oliviera & Schneider (2016) that the concentration withered with the expansion of production in Brazil and China. The market concentration for oil palm fruit has increased, and is the only one which today would clearly fall into the category "highly concentrated market". The reasons for this are captured by this quote by the president of the Colombian FEDEPALMA:

> Oil palm industry development of our world leader, Indonesia, is underpinned by cheap labor force, low production costs and large swathes of land given under concession and other forms by the government. But those conditions are neither easy to find somewhere else, especially in Latin America, nor sustainable. Thus, oil palm agroindustry must build and consolidate com- petitive advantages over more solid bases (Hunsberger & Alonso-Fradejas 2016)

### Individual flex crop planted area proportion of total land area
Large countries will naturally be the ones with the largest area planted. Here we look what proportion of the total crop production is flex crop production and how has it changed over time. With this information we can see if the flex crop production is actually displacing other production.

Here a threshold is set that a country has at minimum 40% of the total area planted are flex crops in 2017. This number was mainly chosen because most countries after that are nations that have maize as a large part of their total production, but has had it for a long time and that share has been fairly stable over time. The reason why 2017 is chosen as a baseline is because it is interesting to focus on the where the production is dominant today, and how that have developed for those countries historically.

```{r  out.width = "100%", out.height = "100%", fig.height = 6, echo = FALSE}

crop_proportion_plot_per_country(crop_data, category = "Flex crop", min_land_area = 500000, min_proportion = 0.4, max_proportion = 1, stacked = TRUE)

```

```{r}
measure = c("Production", "Area harvested", "Yield")
category = "Flex crop"

crop_plot_data = crop_data %>% 
  filter(crop_category == category, measures %in% measure) %>% 
  dplyr::select(year, value, measures, item) %>%
  group_by(year, measures, item) %>% 
  summarize(total_value = sum(value)) %>% 
  group_by(measures) %>%
  mutate(value_index = total_value / total_value) %>% 
  #print()
  group_by(measures, item) %>% 
  mutate(value_index = total_value/total_value[year == min(unique(year))]) %>% 
  group_by(measures, year) %>%
  mutate(fraction_value = total_value / sum(total_value))

# Plot the change over time of flex crops
ggplot(crop_plot_data) +
  geom_line(aes(x=year, y=total_value, colour = str_wrap(item, width = 8))) +
  theme_light(base_size = 10) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  #      geom_vline(xintercept = 2009, linetype = "dotted", color = "black") +
  labs(y = "Area harvested [hectares], Production [tonnes], Yield [tonnes / hectares]", x = "", title = "Crop harvest, production and yield") +
  facet_wrap(~item + measures, ncol = 3, scales = "free_y", labeller = label_wrap_gen(multi_line=FALSE)) +
  scale_y_continuous(limits=c(0,NA), labels = scaleFUN) +
  theme(axis.text.x = element_text(angle=60, hjust=1)) +
  #      guides(shape = guide_legend(override.aes = list(size = 0.5)))
  theme(legend.key.size = unit(0.5, "cm"), legend.text = element_text(size = 6), legend.title = element_blank())

```


Some interesting points from these graphs
* The first interesting observation is that even though we have set the threshold to a 25% and excluded smaller nations we still have 37 countries that have more than (setting it to 10% gives us 78 countries, or 99 countries at 5%). This is a lot more countries than I thought would have their cropland use so dominated by flex crops.

* Both Indonesia and Malaysia are two giants when it comes to production of Palm oil. Here it becomes very clear that Malaysia differs very much from Indonesia in the sense that Malaysia has had an remarkable increase of proportion of oil palm produced. From a almost nothing up until the 70s to more than 50% in 2015.

* Besides the ususal suspects of Brazil and Argentina, in latin america Bolivia, Paraguay and Uruguay has had a growth which deserves more attention. Especially looking at Paraguay and Uruguay who grown from a proportion of area that soybeans are grown on from almost 0 in the 70s to around 60% in 2015 and from close to 0 in 2000 to over 50% in 2015. In the speed this has happened maybe Uruguay is the most remarkable. The question I ask myself is where this land has come from?

* Maize is somewhat fluctuating in area harvested over time, but its proportion generally does not increase much, with a few exeptions (Tanzania, Guatemala and DR Congo).

An interesting question overall here would be on what expense is this expansion of flex crops? In many tropical countries it is known that important biomes, like rainforest in Latin America or South-east Asia or the cerrado in Brazil is cleared for production of for example soy, oil palm and sugar cane plantations. The questions is if flex crops also are expanding into other food production, e.g. if other crops are replaced by the flex crops? If this is true, given that these crops tend to a greater extent (source???) be used for other uses than directly for food, how does that affect food security in a region where this transition has happened? What are the effects on livelihoods of the people who used to live on growing other crops? Are corporations behind this expansion? Where does the demand come from? Have people been displaced from their lands because of this expansion? Have some benefitted and others not? Are these benefits gendered? What sort of governing institutions has made this possible? Where does the financing come from for this expansion? How much are the financial institutions interacting with the governing institutions?

A reflection I have when I write this is that flex crops is bit of a problematic word. The way I use and think of the word is that they are problematic crops, since they have been shown in some cases to have been used to other things that aren't food related (e.g. biofuels, industrial materials etc.) and things that could be argued are not very effective use of calories (e.g. feed). This is true in some cases of course, but in many countries these are staple goods and a very important part of food security. I think it is important to sometimes reflect over that the producton of Maize in the US is very different from Maize production in Malawi, and that should be taken into account when doing this type of analysis.


## Break point analysis
Using the package Fstats, the F statistics is calculated for every potential break point. Two OLS are fitted to the observations before and after the potential break points. The breakpoint that minimizes the RSS is the point that is picked (rdocumentation.org). Here I look at each county's area harvested of a certain crop over time. The distribution of break points are plottet in a histogram, to see if there are certain years with more break points than others. The map is colored after which range that the break point in a specific country falls in. The ranges are chosen to represent the different food regimes defined in (McMichael 2009)

Second food regime: 1950-1970s
Third food regime:  late 1980s-Present

```{r, fig.height = 6, echo = FALSE}
#crop_data = crop_data %>% select(-income_group)
theme_set(theme_light(base_size = 2))
get_break_points_per_country(crop_data, crop = "Oil palm fruit", measure = "Area harvested")
```

Most of the oil palm producing countries has had the break point after 1990s. The exepctions are Paraguay, Benin, Tanzania and Madagascar.


Sources:

McMichael, P. 2009. A food regime genealogy. Journal of Peasant Studies 36(1):139–169.

Mózner, Z., A. Tabi, and M. Csutora. 2012. Modifying the yield factor based on more efficient use of fertilizer - The environmental impacts of intensive and extensive agricultural practices. Ecological Indicators 16:58–66.

Oliveira, G. de L. T., and M. Schneider. 2016. The politics of flexing soybeans: China, Brazil and global agroindustrial restructuring. Journal of Peasant Studies 43(1):167–194.

